<!DOCTYPE html>

<!--
 // WEBSITE: https://themefisher.com
 // TWITTER: https://twitter.com/themefisher
 // FACEBOOK: https://www.facebook.com/themefisher
 // GITHUB: https://github.com/themefisher/
-->

<html lang="en">
<head>

  <!-- Basic Page Needs
  ================================================== -->
  <meta charset="utf-8">
  <title>Clinica Concordia</title>

  <!-- Mobile Specific Metas
  ================================================== -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Clínica Concórdia: atendimento psicológico de qualidade em Governador Valadares. Oferecemos terapias para ansiedade, depressão, estresse e mais. Agende sua consulta.">
  <meta name="author" content="Clínica Concórdia">
  <meta name="generator" content="Clínica Concórdia Website v1.0">
  
  <!-- theme meta -->
  <meta name="theme-name" content="novena" />

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.png" />

  <!-- 
  Essential stylesheets
  =====================================-->
  <link rel="stylesheet" href="plugins/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="plugins/icofont/icofont.min.css">
  <link rel="stylesheet" href="plugins/slick-carousel/slick/slick.css">
  <link rel="stylesheet" href="plugins/slick-carousel/slick/slick-theme.css">
  <!-- intl-tel-input CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css">

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="css/style.css">

</head>

<body id="top">

<header>
	<div class="header-top-bar">
		<div class="container">
			<div class="row align-items-center">
				<div class="col-lg-6">
					<ul class="top-bar-info list-inline-item pl-0 mb-0">
						<li class="list-inline-item"><a href="mailto:support@gmail.com"><i class="icofont-support-faq mr-2"></i>contato@concordia.com</a></li>
						<li class="list-inline-item"><i class="icofont-location-pin mr-2"></i>Endereço: Joao e Maria, 1534</li>
					</ul>
				</div>
				<div class="col-lg-6">
					<div class="text-lg-right top-right-bar mt-2 mt-lg-0">
						<a href="tel:+23-345-67890">
							<span>Contato : </span>
							<span class="h4">(33) 0000-0000</span>
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<nav class="navbar navbar-expand-lg navigation" id="navbar">
		<div class="container">
			<a class="navbar-brand" href="index.html">
				<img src="images/logo.png" alt="" class="img-fluid">
			</a>

			<button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarmain"
				aria-controls="navbarmain" aria-expanded="false" aria-label="Toggle navigation">
				<span class="icofont-navigation-menu"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarmain">
				<ul class="navbar-nav ml-auto">
					<li class="nav-item active"><a class="nav-link" href="index.html">Home</a></li>
					<li class="nav-item"><a class="nav-link" href="about.html">Sobre nós</a></li>

					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="doctor.html" id="dropdown03" data-toggle="dropdown"
							aria-haspopup="true" aria-expanded="false">Profissionais <i class="icofont-thin-down"></i></a>
						<ul class="dropdown-menu" aria-labelledby="dropdown03">
							<li><a class="dropdown-item" href="doctor.html">Cibele Eloá</a></li>
							<li><a class="dropdown-item" href="doctor-single.html">Fulano 2</a></li>
							<li><a class="dropdown-item" href="appoinment.html">Fulano 3</a></li>
							<li><a class="dropdown-item" href="appoinment.html">Fulano 4</a></li>
						</ul>
					</li>

					<li class="nav-item"><a class="nav-link" href="about.html"> Blog </a></li>
					<li class="nav-item"><a class="nav-link" href="contact.html">Agende agora</a></li>
				</ul>
			</div>
		</div>
	</nav>
</header>

<section class="page-title bg-1">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="block text-center">
          <span class="text-white">Garanta seu horário</span>
          <h1 class="text-capitalize mb-5 text-lg">Agendamento</h1>

          <!-- <ul class="list-inline breadcumb-nav">
            <li class="list-inline-item"><a href="index.html" class="text-white">Home</a></li>
            <li class="list-inline-item"><span class="text-white">/</span></li>
            <li class="list-inline-item"><a href="#" class="text-white-50">Garanta seu horário</a></li>
          </ul> -->
        </div>
      </div>
    </div>
  </div>
</section>

<section class="appoinment section">
  <div class="container">
    <div class="row">
      <div class="col-lg-4">
          <div class="mt-3">
            <div class="feature-icon mb-3">
              <i class="icofont-support text-lg"></i>
            </div>
             <span class="h3">Precisa de Ajuda Urgente?</span>
             <h2 class="text-color mt-3">+55 (XX) XXXX-XXXX</h2>
          </div>
      </div>

      <div class="col-lg-8">
           <div class="appoinment-wrap mt-5 mt-lg-0 pl-lg-5">
             <h2 class="mb-2 title-color">Faça um Agendamento</h2>
             <p class="mb-4">Preencha os dados abaixo para marcar sua consulta. O agendamento só será confirmado após o pagamento via Pix.</p>
               
             <form id="appointment-form" class="appoinment-form">
                  <div class="row">
                       <div class="col-lg-6">
                           <div class="form-group">
                              <select class="form-control" id="professional-select" required>
                                <option value="">Selecione o Profissional</option>
                              </select>
                           </div>
                       </div>
                       <div class="col-lg-6">
                         <div class="form-group">
                           <input name="date" id="date-select" type="date" class="form-control" required>
                         </div>
                       </div>

                       <div class="col-lg-12">
                          <div class="form-group">
                            <h5 class="mb-3">Horários Disponíveis:</h5>
                            <div id="time-slots" class="row">
                              <p class="col-12 text-muted">Selecione um profissional e uma data para ver os horários.</p>
                            </div>
                            <input type="hidden" id="time-selected" name="time" required>
                          </div>
                       </div>

                       <div class="col-lg-6">
                           <div class="form-group">
                              <input name="name" id="name" type="text" class="form-control" placeholder="Nome Completo" required>
                           </div>
                       </div>

                       <div class="col-lg-6">
                           <div class="form-group">
                              <input name="phone" id="phone" type="tel" class="form-control" required>
                           </div>
                       </div>

                       <!-- NOVO CAMPO DE CPF/CNPJ -->
                        <div class="col-lg-6">
                            <div class="form-group">
                            <input name="document" id="document" type="text" class="form-control" placeholder="CPF" required>
                            </div>
                        </div>

                        <!-- Adicione o campo de Email também, que é essencial -->
                        <div class="col-lg-6">
                            <div class="form-group">
                            <input name="email" id="email" type="email" class="form-control" placeholder="Seu E-mail" required>
                            </div>
                        </div>

                        <!-- Adicione estes campos dentro do <div class="row"> do seu formulário -->

                        <div class="col-lg-6">
                            <div class="form-group">
                            <input name="zip_code" id="zip_code" type="text" class="form-control" placeholder="CEP" required>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                            <input name="street" id="street" type="text" class="form-control" placeholder="Rua / Logradouro" required>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="form-group">
                            <input name="street_number" id="street_number" type="text" class="form-control" placeholder="Número" required>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="form-group">
                            <input name="neighborhood" id="neighborhood" type="text" class="form-control" placeholder="Bairro" required>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="form-group">
                            <input name="city" id="city" type="text" class="form-control" placeholder="Cidade" required>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="form-group">
                            <input name="state" id="state" type="text" class="form-control" placeholder="Estado (UF)" required maxlength="2">
                            </div>
                        </div>

                  </div>
                  <div class="form-group-2 mb-4">
                      <textarea name="message" id="message" class="form-control" rows="4" placeholder="Sua mensagem (opcional)"></textarea>
                  </div>
                  
                  <button type="submit" class="btn btn-main btn-round-full">Confirmar e Pagar <i class="icofont-simple-right ml-2"></i></button>
             </form>
           </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal de Pagamento PIX -->
<div class="modal fade" id="pixModal" tabindex="-1" role="dialog" aria-labelledby="pixLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content p-4">
      <h5 id="pixLabel" class="mb-3">Confirme e Pague com Pix</h5>
      
      <div id="appointment-summary" class="alert alert-light mb-3">
        <p class="mb-1"><strong>Profissional:</strong> <span id="summary-professional"></span></p>
        <p class="mb-1"><strong>Data:</strong> <span id="summary-date"></span></p>
        <p class="mb-0"><strong>Horário:</strong> <span id="summary-time"></span></p>
      </div>
      
      <img id="qrImg" alt="QR Code Pix" class="img-fluid mb-3 mx-auto d-block" style="max-width: 220px;"/>
      
      <div class="input-group mb-3">
        <input type="text" id="pixCopy" class="form-control" readonly>
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" id="copy-button">Copiar</button>
        </div>
      </div>
      
      <p class="text-muted mb-0 small text-center">Após o pagamento, seu agendamento será confirmado automaticamente.</p>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTOS DO DOM ---
    const form = document.getElementById('appointment-form');
    if (!form) {
        console.error('ERRO: Formulário com id "appointment-form" não encontrado!');
        return;
    }
    
    const professionalSelect = document.getElementById('professional-select');
    const dateSelect = document.getElementById('date-select');
    const timeSlotsContainer = document.getElementById('time-slots');
    const timeSelectedInput = document.getElementById('time-selected');
    const phoneInputField = document.getElementById('phone');

    // --- DECLARAÇÃO DA VARIÁVEL EM ESCOPO SUPERIOR ---
    let phoneInput; 

    // --- DADOS E INICIALIZAÇÃO ---
    let professionalsData = [];

    function initializePhoneInput() {
        phoneInput = window.intlTelInput(phoneInputField, {
            nationalMode: true,
            initialCountry: "auto",
            geoIpLookup: callback => {
                fetch("https://freegeoip.app/json/").then(res => res.json()).then(data => callback(data.country_code)).catch(() => callback("br"));
            },
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js",
        });
    }

    async function populateProfessionals() {
        try {
            const response = await fetch('/api/professionals');
            professionalsData = await response.json();
            professionalsData.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                professionalSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Erro ao carregar profissionais:', error);
        }
    }

    async function loadTimeSlots() {
        const professionalId = professionalSelect.value;
        const date = dateSelect.value;
        timeSelectedInput.value = '';
        if (!professionalId || !date) {
            timeSlotsContainer.innerHTML = '<p class="col-12 text-muted">Selecione um profissional e uma data para ver os horários.</p>';
            return;
        }
        timeSlotsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="sr-only">Carregando...</span></div></div>';
        try {
            const response = await fetch(`/api/availability?professionalId=${professionalId}&date=${date}`);
            if (!response.ok) throw new Error('Falha ao buscar horários da API.');
            const slots = await response.json();
            timeSlotsContainer.innerHTML = '';
            if (slots.length === 0) {
                timeSlotsContainer.innerHTML = '<p class="col-12 text-muted">Nenhum horário disponível para esta data.</p>';
                return;
            }
            slots.forEach(slot => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 mb-2';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-primary btn-block';
                btn.textContent = new Date(slot.start).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                btn.dataset.time = slot.start;
                btn.onclick = () => {
                    timeSelectedInput.value = btn.dataset.time;
                    document.querySelectorAll('#time-slots button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                col.appendChild(btn);
                timeSlotsContainer.appendChild(col);
            });
        } catch (error) {
            timeSlotsContainer.innerHTML = '<p class="col-12 text-danger">Erro ao carregar horários. Tente novamente.</p>';
            console.error(error);
        }
    }

    async function handleFormSubmit(event) {
        event.preventDefault();

        if (!phoneInput || !phoneInputField.value.trim()) {
            alert('Por favor, insira um número de telefone.');
            return;
        }
        const numberData = phoneInput.getNumber(intlTelInputUtils.numberFormat.E164);
        if (!numberData) {
            alert('O formato do telefone parece inválido. Verifique o número digitado.');
            return;
        }
        if (!timeSelectedInput.value) {
            alert('Por favor, selecione um horário.');
            return;
        }

        const professionalId = professionalSelect.value;
        const professional = professionalsData.find(p => p.id === professionalId);
        
        const selectedDate = new Date(dateSelect.value + 'T00:00:00-03:00');
        const selectedTime = new Date(timeSelectedInput.value);
        const endTime = new Date(selectedTime.getTime() + 60 * 60 * 1000);

        document.getElementById('summary-professional').textContent = professional.name;
        document.getElementById('summary-date').textContent = selectedDate.toLocaleDateString('pt-BR');
        document.getElementById('summary-time').textContent = selectedTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

        const countryData = phoneInput.getSelectedCountryData();
        
        // --- CORREÇÃO AQUI: Declarando a variável antes de usá-la ---
        const documentRaw = document.getElementById('document').value.replace(/\D/g, '');

        const customer = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            type: documentRaw.length > 11 ? 'company' : 'individual',
            document: documentRaw,
            address: {
                country: countryData.iso2.toUpperCase(),
                state: document.getElementById('state').value,
                city: document.getElementById('city').value,
                zip_code: document.getElementById('zip_code').value.replace(/\D/g, ''),
                line_1: `${document.getElementById('street').value}, ${document.getElementById('street_number').value}`,
                line_2: document.getElementById('neighborhood').value
            },
            phones: {
                mobile_phone: {
                    country_code: countryData.dialCode,
                    area_code: numberData.substring(countryData.dialCode.length + 1, countryData.dialCode.length + 3),
                    number: numberData.substring(countryData.dialCode.length + 3)
                }
            }
        };

        const metadata = {
            calendarId: professional.calendarId,
            summary: `Consulta com ${professional.name}`,
            description: document.getElementById('message').value || 'Agendamento via site.',
            startISO: selectedTime.toISOString(),
            endISO: endTime.toISOString(),
            attendeePhone: numberData,
            attendeeEmail: customer.email
        };

        try {
            const response = await fetch('/api/checkout/pix', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amountInCents: 10000, customer, metadata })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Erro retornado pelo backend:', errorData);
                throw new Error('Falha na comunicação com o servidor de pagamento.');
            }

            const order = await response.json();

                // --- RENDERIZAÇÃO CORRETA DO QR CODE ---
                if (order.qrCodePayload) {
                // Gera o QR Code a partir do payload "copia e cola"
                const qr = qrcode(0, 'L');
                qr.addData(order.qrCodePayload);
                qr.make();
                document.getElementById('qrImg').src = qr.createDataURL(4);
                } else {
                // Esconde a imagem se não houver QR Code
                document.getElementById('qrImg').style.display = 'none';
                }

                document.getElementById('pixCopy').value = order.pixCopyPaste;

                $('#pixModal').modal('show');

                $('#pixModal').modal('show');
        } catch (error) {
            alert('Não foi possível gerar o pagamento Pix. Verifique os dados e tente novamente.');
            console.error('Erro no checkout:', error);
        }
    }
    
    document.getElementById('copy-button').addEventListener('click', () => {
        const pixInput = document.getElementById('pixCopy');
        navigator.clipboard.writeText(pixInput.value).then(() => alert('Código Pix copiado!'));
    });

    form.addEventListener('submit', handleFormSubmit);
    professionalSelect.addEventListener('change', loadTimeSlots);
    dateSelect.addEventListener('change', loadTimeSlots);
    
    initializePhoneInput();
    populateProfessionals();
});
</script>


<!-- footer Start -->
<footer class="footer section gray-bg">
	<div class="container">
		<div class="row">
			<div class="col-lg-4 mr-auto col-sm-6">
				<div class="widget mb-5 mb-lg-0">
					<div class="logo mb-4">
						<img src="images/logo.png" alt="" class="img-fluid">
					</div>
					<p>Concordia Mentis Clínica é uma instituição de saúde mental que integra serviços de psiquiatria e psicologia. Oferecemos diagnósticos clínicos, tratamentos farmacológicos e sessões de terapia, adaptados a pacientes individuais ou familiares.</p>

					<ul class="list-inline footer-socials mt-4">
						<li class="list-inline-item">
							<a href="https://www.facebook.com/themefisher"><i class="icofont-facebook"></i></a>
						</li>
						<li class="list-inline-item">
							<a href="https://twitter.com/themefisher"><i class="icofont-twitter"></i></a>
						</li>
						<li class="list-inline-item">
							<a href="https://www.instagram.com/themefisher/"><i class="icofont-instagram"></i></a>
						</li>
					</ul>
				</div>
			</div>

			<div class="col-lg-2 col-md-6 col-sm-6">
				<div class="widget mb-5 mb-lg-0">
					<h4 class="text-capitalize mb-3">Departamentos</h4>
					<div class="divider mb-4"></div>

					<ul class="list-unstyled footer-menu lh-35">
						<li><a href="#!">Blog</a></li>
						<li><a href="#!">Profissionais</a></li>
						<li><a href="#!">Sobre Nós</a></li>
						<li><a href="#!">Agende</a></li>
					</ul>
				</div>
			</div>

			<div class="col-lg-2 col-md-6 col-sm-6">
				<div class="widget mb-5 mb-lg-0">
					<h4 class="text-capitalize mb-3">Suporte</h4>
					<div class="divider mb-4"></div>

					<ul class="list-unstyled footer-menu lh-35">
						<li><a href="#!">Termos e Condições</a></li>
						<li><a href="#!">Políticas de privacidade</a></li>
						<li><a href="#!">Perguntas Frequentes</a></li>
						<li><a href="#!">Alvará</a></li>
					</ul>
				</div>
			</div>

			<div class="col-lg-3 col-md-6 col-sm-6">
				<div class="widget widget-contact mb-5 mb-lg-0">
					<h4 class="text-capitalize mb-3">Contato</h4>
					<div class="divider mb-4"></div>

					<div class="footer-contact-block mb-4">
						<div class="icon d-flex align-items-center">
							<i class="icofont-email mr-3"></i>
							<span class="h6 mb-0">Converse com nossa equipe</span>
						</div>
						<h4 class="mt-2"><a href="mailto:support@email.com">Suporte@concordia.com</a></h4>
					</div>

					<div class="footer-contact-block">
						<div class="icon d-flex align-items-center">
							<i class="icofont-support mr-3"></i>
							<span class="h6 mb-0">Segunda a sexta : 08:30 - 18:00</span>
						</div>
						<h4 class="mt-2"><a href="tel:+23-345-67890">+55 11 90000-0000</a></h4>
					</div>
				</div>
			</div>
		</div>

		<div class="footer-btm py-4 mt-5">
			<div class="row align-items-center justify-content-between">
				<div class="col-lg-6">
					<div class="copyright">
						Copyright &copy; 2025, Concordia Mentis</a>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="subscribe-form text-lg-right mt-5 mt-lg-0">
						<form action="#" class="subscribe">
							<input type="text" class="form-control" placeholder="Seu Email" required>
							<button type="submit" class="btn btn-main-2 btn-round-full">Se inscreva</button>
						</form>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-lg-4">
					<a class="backtop scroll-top-to" href="#top">
						<i class="icofont-long-arrow-up"></i>
					</a>
				</div>
			</div>
		</div>
	</div>
</footer>
   

    <!-- 
    Essential Scripts
    =====================================-->
    <script src="plugins/jquery/jquery.js"></script>
    <script src="plugins/bootstrap/bootstrap.min.js"></script>
    <script src="plugins/slick-carousel/slick/slick.min.js"></script>
    <script src="plugins/shuffle/shuffle.min.js"></script>
    <!-- intl-tel-input JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/intlTelInput.min.js"></script>

    <!-- Seu script de agendamento (appointment.html) virá depois -->
    <!-- Biblioteca para gerar QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <!-- Google Map -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkeLMlsiwzp6b3Gnaxd86lvakimwGA6UA"></script>
    <script src="plugins/google-map/gmap.js"></script>
    
    <script src="js/script.js"></script>

      <!-- jQuery -->
    <script src="plugins/jquery/jquery.js"></script>
    <!-- Bootstrap JS -->
    <script src="plugins/bootstrap/bootstrap.min.js"></script>
    <!-- Seu script customizado (se existir) -->
    <script src="js/script.js"></script>


  </body>
  </html>
